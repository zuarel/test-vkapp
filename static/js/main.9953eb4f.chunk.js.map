{"version":3,"sources":["pages/main.jsx","App.js","index.js"],"names":["MainPage","App","connect","send","ReactDOM","render","document","getElementById"],"mappings":"ueAUeA,G,sDAJE,WACb,OAAQ,2CC4WGC,EAtVH,WAER,OAAO,kBAAC,EAAD,OCtBXC,IAAQC,KAAK,gBASbC,IAASC,OAAO,kBAAC,EAAD,MAASC,SAASC,eAAe,U","file":"static/js/main.9953eb4f.chunk.js","sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport connect from '@vkontakte/vk-connect';\r\nimport View from '@vkontakte/vkui/dist/components/View/View';\r\nimport '@vkontakte/vkui/dist/vkui.css';\r\nimport '../css/vkapp.css';\r\n\r\nconst MainPage = () => {\r\n    return (<h1>Main page</h1>);\r\n}\r\n\r\nexport default MainPage;","import React, { useState, useEffect } from 'react';\r\nimport connect from '@vkontakte/vk-connect';\r\nimport View from '@vkontakte/vkui/dist/components/View/View';\r\nimport '@vkontakte/vkui/dist/vkui.css';\r\nimport './css/vkapp.css';\r\n\r\nimport { Panel, PanelHeader, Alert, Div, Button, ScreenSpinner } from '@vkontakte/vkui';\r\nimport SubscriptionItem from './components/SubscriptionItem';\r\nimport MainPage from './pages/main';\r\n\r\n\r\nconst getObjectFromURL = (url) => {\r\n    const search = url.slice(1);\r\n    const params = search.split('&');\r\n\r\n    return params.reduce((acc, item) => {\r\n\r\n        const [key, value] = item.split('=');\r\n\r\n        acc[key] = value;\r\n\r\n        return acc;\r\n    }, {});\r\n};\r\n\r\nconst buildQuery = (params) => {\r\n    return Object.entries(params).map((item) => item.join('=')).join('&');\r\n}\r\n\r\nconst App = () => {\r\n\r\n    return <MainPage />\r\n\r\n    const hashObject = getObjectFromURL(window.location.hash);\r\n    const searchObject = getObjectFromURL(window.location.search);\r\n\r\n    const vk_group_id = searchObject.vk_group_id || '';\r\n    const user_vk_id = searchObject.vk_user_id;\r\n    const subscriptionId = hashObject.s || '';\r\n    var tag_id = hashObject.u || '';\r\n\r\n    const [subscriptions, setSubscriptions] = useState([]);\r\n    const [isGroupInfoLoading, setGroupInfoLoading] = useState(false);\r\n    const [popout, setPopout] = useState(null);\r\n    const [groupInfo, setGroupInfo] = useState({\r\n        description: '',\r\n        avatar: '',\r\n        name: '',\r\n        banner: '',\r\n        unsubscribeColor: '',\r\n        subscribeColor: ''\r\n    });\r\n\r\n    const loadGroupInfo = async () => {\r\n        if (isGroupInfoLoading) {\r\n            return;\r\n        }\r\n\r\n        setGroupInfoLoading(true);\r\n\r\n        try {\r\n            const res = await fetch('https://smm-n.targethunter.dev/ajax?' + buildQuery({ method: 'vkapp.load_info', group_id: vk_group_id, user_vk_id }));\r\n            const { subscriptions, ...data } = await res.json();\r\n\r\n\r\n            if (data.status !== 'ok') {\r\n                throw new Error('Не удалось загрузить данные.');\r\n            }\r\n\r\n            setGroupInfo({\r\n                ...groupInfo,\r\n                description: data.description,\r\n                avatar: data.avatar,\r\n                name: data.name,\r\n                banner: data.banner,\r\n                subscribeColor: data.subscribe_color,\r\n                unsubscribeColor: data.unsubscribe_color\r\n            });\r\n\r\n            setSubscriptions(subscriptions);\r\n        } catch (error) {\r\n            setGroupInfoLoading(true);\r\n\r\n            setPopout(<Alert\r\n                actions={[{\r\n                    title: 'закрыть',\r\n                    autoclose: true,\r\n                    style: 'cancel'\r\n                }]}\r\n                onClose={() => setPopout(null)}\r\n            >\r\n                <h2>Что-то пошло не так.</h2>\r\n                <p>{error.message}</p>\r\n            </Alert>);\r\n        }\r\n    };\r\n\r\n    const source = subscriptionId ? 2 : 1;\r\n\r\n    const item = subscriptions.find(subscription => subscription.id === subscriptionId);\r\n\r\n    const pageDescription = item\r\n        ? (item.description || '')\r\n        : groupInfo.description || '';\r\n\r\n    const subscribeItem = async (item) => {\r\n\r\n        var fd = new FormData();\r\n\r\n        fd.append('user_vk_id', user_vk_id);\r\n        fd.append('group_id', vk_group_id);\r\n        fd.append('subscribe_id', item.id);\r\n        fd.append('source', String(source));\r\n        fd.append('tag_id', tag_id);\r\n\r\n        fd.append('utm_source', hashObject['utm_source'] || '');\r\n        fd.append('utm_medium', hashObject['utm_medium'] || '');\r\n        fd.append('utm_campaign', hashObject['utm_campaign'] || '');\r\n        fd.append('utm_content', hashObject['utm_content'] || '');\r\n        fd.append('utm_term', hashObject['utm_term'] || '');\r\n        fd.append('params', JSON.stringify(searchObject));\r\n\r\n        const res = await fetch('https://smm-n.targethunter.dev/ajax?' + buildQuery({ method: 'vkapp.subscribe_user', }),\r\n            { method: 'POST', body: fd });\r\n\r\n        const { status, ...data } = await res.json();\r\n\r\n        if (status !== 'ok') {\r\n            throw new Error(data.text || 'Что-то пошло не так. Не удалось подписаться');\r\n        }\r\n\r\n        const s = subscriptions.map(item => item);\r\n        const i = s.find(subscription => subscription.id === item.id);\r\n\r\n        i.isSubscribed = true;\r\n        i.count = item.count + 1\r\n\r\n        setSubscriptions(s);\r\n    };\r\n\r\n    let lastPressedItem = null;\r\n\r\n    connect.subscribe(async ({ detail: { type } }) => {\r\n        if (type === 'VKWebAppAllowMessagesFromGroupResult') {\r\n            await subscribeItem(lastPressedItem);\r\n        }\r\n    });\r\n\r\n    const onSubscribe = async (item) => {\r\n\r\n        showSpinner();\r\n\r\n        lastPressedItem = item;\r\n\r\n        try {\r\n            const res1 = await fetch('https://smm-n.targethunter.dev/ajax?' + buildQuery({\r\n                user_vk_id,\r\n                method: 'vkapp.check_allowed',\r\n                group_id: vk_group_id,\r\n            }));\r\n\r\n            const { is_messages_from_group_allowed } = await res1.json();\r\n\r\n            if (!is_messages_from_group_allowed) {\r\n                connect.send('VKWebAppAllowMessagesFromGroup', { group_id: +vk_group_id });\r\n                setPopout(null);\r\n                return;\r\n            }\r\n\r\n            await subscribeItem(item);\r\n            openSubscribeModal(true);\r\n        } catch (error) {\r\n            setPopout(null);\r\n            alert(error.toString());\r\n        }\r\n\r\n        lastPressedItem = null;\r\n    };\r\n\r\n    const unsubscribeItem = async (item) => {\r\n\r\n        const fd = new FormData();\r\n\r\n        fd.append('user_vk_id', user_vk_id);\r\n        fd.append('group_id', vk_group_id);\r\n        fd.append('subscribe_id', item.id);\r\n        fd.append('source', String(source));\r\n        fd.append('tag_id', tag_id);\r\n\r\n        fd.append('utm_source', hashObject['utm_source'] || '');\r\n        fd.append('utm_medium', hashObject['utm_medium'] || '');\r\n        fd.append('utm_campaign', hashObject['utm_campaign'] || '');\r\n        fd.append('utm_content', hashObject['utm_content'] || '');\r\n        fd.append('utm_term', hashObject['utm_term'] || '');\r\n        fd.append('params', JSON.stringify(searchObject));\r\n\r\n        const res = await fetch('https://smm-n.targethunter.dev/ajax?' + buildQuery({\r\n            method: 'vkapp.unsubscribe_user',\r\n        }), { method: 'POST', body: fd });\r\n\r\n        const { status, ...data } = await res.json();\r\n\r\n        if (status !== 'ok') {\r\n            throw new Error(data.text || 'Что-то пошло не так. Не удалось отписаться');\r\n        }\r\n\r\n        item.isSubscribed = false;\r\n        item.count = item.count - 1\r\n\r\n        return item;\r\n    }\r\n\r\n    const onUnsubscribe = async (item) => {\r\n        try {\r\n            showSpinner();\r\n\r\n            var s = subscriptions.map(item => item);\r\n            var i = s.find(subscription => subscription.id === item.id);\r\n\r\n            await unsubscribeItem(i);\r\n\r\n            setSubscriptions(s);\r\n            openUnsubscribeModal();\r\n        } catch (error) {\r\n            setPopout(null);\r\n            alert(error.message);\r\n        }\r\n    };\r\n\r\n    const unsubscribeAll = async () => {\r\n\r\n        showSpinner();\r\n        try {\r\n\r\n            const fd = new FormData();\r\n\r\n            fd.append('user_vk_id', user_vk_id);\r\n            fd.append('group_id', vk_group_id);\r\n            fd.append('source', String(source));\r\n            fd.append('tag_id', tag_id);\r\n\r\n            fd.append('utm_source', hashObject['utm_source'] || '');\r\n            fd.append('utm_medium', hashObject['utm_medium'] || '');\r\n            fd.append('utm_campaign', hashObject['utm_campaign'] || '');\r\n            fd.append('utm_content', hashObject['utm_content'] || '');\r\n            fd.append('utm_term', hashObject['utm_term'] || '');\r\n            fd.append('params', JSON.stringify(searchObject));\r\n\r\n            const res = await fetch('https://smm-n.targethunter.dev/ajax?' + buildQuery({\r\n                method: 'vkapp.unsubscribe_all',\r\n            }), { method: 'POST', body: fd });\r\n\r\n\r\n            const data = await res.json();\r\n\r\n            if (data.status !== 'ok') {\r\n                throw new Error(data.text || 'Что-то пошло не так. Не удалось отписаться');\r\n            }\r\n\r\n            showSpinner();\r\n\r\n            const s = subscriptions.map(item => item);\r\n\r\n            for (const subscription of s) {\r\n                \r\n                if (!subscription.isSubscribed) {\r\n                    continue;\r\n                }\r\n\r\n                subscription.isSubscribed = false;\r\n                subscription.count = subscription.count - 1\r\n            }\r\n\r\n            setSubscriptions(s);\r\n            openUnsubscribeModal();\r\n        } catch (error) {\r\n            setPopout(null);\r\n            alert(error.toString());\r\n        }\r\n\r\n    };\r\n\r\n    const openSubscribeModal = (showDialogLink) => {\r\n\r\n        setPopout(<Alert\r\n            actions={[{\r\n                title: 'закрыть',\r\n                autoclose: true,\r\n                style: 'cancel'\r\n            }]}\r\n            onClose={() => setPopout(null)}\r\n        >\r\n            <h2>Вы успешно подписались на рссылку.</h2>\r\n            <p>Рассылка скоро придёт Вам в личные сообщения.</p>\r\n\r\n            {showDialogLink && <Div>\r\n                <Button onClick={() => window.top.location.href = 'https://vk.com/im?sel=-' + vk_group_id} size=\"l\" stretched>Перейти к сообщениям</Button>\r\n            </Div>}\r\n        </Alert>);\r\n    }\r\n\r\n    const openUnsubscribeModal = () => {\r\n        setPopout(<Alert\r\n            actions={[{\r\n                title: 'закрыть',\r\n                autoclose: true,\r\n                style: 'cancel'\r\n            }]}\r\n            onClose={() => setPopout(null)}\r\n        >\r\n            <h2>Вы отписаны.</h2>\r\n            <p>Рассылка Вам больше не будет приходить.</p>\r\n        </Alert>);\r\n    }\r\n\r\n    const showSpinner = () => {\r\n        setPopout(<ScreenSpinner size=\"large\" />);\r\n    }\r\n\r\n    useEffect(() => {\r\n        loadGroupInfo();\r\n    });\r\n\r\n    return (\r\n        <View popout={popout} activePanel=\"main\">\r\n            <Panel id=\"main\">\r\n                <PanelHeader>Рассылка сообщений</PanelHeader>\r\n                <div style={{ textAlign: 'center' }}>\r\n                    {item && item.banner\r\n                        && <img src={item.banner} alt=\"Баннер\" style={{ maxWidth: '100%' }}></img>}\r\n\r\n                    {groupInfo.banner\r\n                        && <img src={groupInfo.banner} alt=\"Баннер\" style={{ maxWidth: '100%' }}></img>}\r\n                </div>\r\n\r\n                <div style={{ padding: '15px' }}>\r\n\r\n                    {((!item || !item.banner) && !groupInfo.banner)\r\n                        && <p className=\"page-title\">\r\n                            <img src={groupInfo.avatar} alt=\"Аватарка паблика\" style={{ borderRadius: '50%', marginRight: '16px' }} />\r\n                            {groupInfo.name}</p>\r\n                    }\r\n\r\n                    <p className=\"page-description\">{pageDescription}</p>\r\n\r\n\r\n                    {subscriptions.filter(subscription => (!subscriptionId || subscription.id === subscriptionId)).map(subscription =>\r\n                        <SubscriptionItem\r\n                            item={subscription}\r\n                            source={source}\r\n                            subscribe={onSubscribe}\r\n                            unsubscribe={onUnsubscribe}\r\n                            subscribeColor={groupInfo.subscribeColor}\r\n                            unsubscribeColor={groupInfo.unsubscribeColor}\r\n                            isSubscriptionPage={!!item}\r\n                            key={subscription.id} />\r\n                    )}\r\n\r\n                    {subscriptions.filter(item => item.isSubscribed).length > 0 && <div style={{ textAlign: 'center' }}>\r\n                        <button\r\n                            onClick={unsubscribeAll}\r\n                            data-source=\"1\" style={{ backgroundColor: groupInfo.unsubscribeColor }}\r\n                            className=\"subscriptions-group-button unsubscribe-button unsubscribe-all\"\r\n                            id=\"unsubscribe-all\">Отписаться от всех рассылок</button>\r\n                    </div>}\r\n                </div>\r\n            </Panel>\r\n        </View >\r\n    );\r\n}\r\n\r\nexport default App;\r\n\r\n","import 'core-js/features/map';\r\nimport 'core-js/features/set';\r\nimport React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport connect from '@vkontakte/vk-connect';\r\nimport App from './App';\r\n// import registerServiceWorker from './sw';\r\n\r\n// Init VK  Mini App\r\nconnect.send('VKWebAppInit');\r\n\r\n\r\n// Если вы хотите, чтобы ваше веб-приложение работало в оффлайне и загружалось быстрее,\r\n// расскомментируйте строку с registerServiceWorker();\r\n// Но не забывайте, что на данный момент у технологии есть достаточно подводных камней\r\n// Подробнее про сервис воркеры можно почитать тут — https://vk.cc/8MHpmT\r\n// registerServiceWorker();\r\n\r\nReactDOM.render(<App />, document.getElementById('root'));\r\n"],"sourceRoot":""}